# ðŸ”’ SYSTEM INSTRUCTIONS FOR ALL CHATS

**Last Updated:** January 14, 2026  
**Status:** CRITICAL - READ BEFORE EVERY CHAT

---

## âš ï¸ GOLDEN RULE

**PROJECT_DOCUMENTATION.md is the authoritative source of truth for this project.**

Every decision, every feature, every bug fix must:
1. Check PROJECT_DOCUMENTATION.md first
2. Follow established patterns in PROJECT_DOCUMENTATION.md
3. Update PROJECT_DOCUMENTATION.md after implementation

---

## ðŸ“š Key Instructions

### **0. Docker & Local Development Setup**
- **Always use `./dc.sh` for Docker operations** instead of localhost
- `./dc.sh` is a convenience wrapper for docker compose with proper `.env.local` and configuration
- **Exception: For database migrations only**
  - Use localhost: `python manage.py makemigrations` (NOT `./dc.sh`)
  - This allows you to create migrations directly from your local Django environment
  - Apply migrations with Docker: `./dc.sh exec web python manage.py migrate`
- Examples:
  - âœ… `./dc.sh up -d` (start services)
  - âœ… `./dc.sh exec web python manage.py runserver` (run in container)
  - âœ… `python manage.py makemigrations` (create migrations locally)
  - âŒ `docker compose -f deploy/docker-compose.yml up -d` (use `./dc.sh` instead)

### **0.5 Testing Code Changes with `./dc.sh` & Logs**

**Every code change must be tested with Docker services running and verified through logs.**

#### **1. Verify Services Are Running**

```bash
# Start services
./dc.sh up -d

# Check all services are running
./dc.sh ps

# Expected output should show all healthy:
# NAME                STATUS              PORTS
# finance-web         running
# finance-db          running
# finance-redis       running
# finance-celery      running
# finance-celery-beat running
# finance-ollama      running
```

#### **2. Check Service Health**

```bash
# Test web service is responding
curl http://localhost:8000/health

# Test API is working
curl http://localhost:8000/api/accounts/auth/check

# Test frontend loads
curl http://localhost:8000
```

#### **3. Check Logs After Code Changes**

**Always review logs after deploying code to catch runtime errors:**

```bash
# Web service logs (most important for Django errors)
./dc.sh logs web -f --tail=50

# Celery worker logs (for background tasks)
./dc.sh logs celery-worker -f --tail=50

# Celery beat logs (for scheduled tasks)
./dc.sh logs celery-beat -f --tail=20

# Database logs (for migration issues)
./dc.sh logs db -f --tail=20

# All services logs
./dc.sh logs -f --tail=50
```

#### **4. Run Specific Tests**

```bash
# Run all tests
./dc.sh exec web python manage.py test

# Run tests in specific app
./dc.sh exec web python manage.py test finance_project.apps.banking.tests

# Run with verbose output
./dc.sh exec web python manage.py test --verbosity=2

# Run pytest suite
./dc.sh exec web pytest

# Run pytest with coverage
./dc.sh exec web pytest --cov
```

#### **5. Common Error Checks**

**After migrations:**
```bash
# Check for migration errors
./dc.sh logs web | grep -i "error\|failed\|migration"

# Verify migrations ran successfully
./dc.sh exec web python manage.py showmigrations
```

**After code changes:**
```bash
# Check for syntax errors
./dc.sh logs web | grep -i "syntaxerror\|importerror\|modulenotfound"

# Check for import issues
./dc.sh logs web | grep -i "traceback\|error"
```

**After API changes:**
```bash
# Check if endpoints are registered
./dc.sh exec web python manage.py shell
# >>> from django.urls import get_resolver
# >>> resolver = get_resolver()
# >>> resolver.url_patterns
```

#### **6. Debugging Workflow**

```bash
# If something breaks:

# Step 1: Check web logs
./dc.sh logs web -f --tail=100

# Step 2: Check specific error (e.g., 500 error)
curl -v http://localhost:8000/api/endpoint/

# Step 3: Check database connection
./dc.sh exec web python manage.py dbshell

# Step 4: Restart affected service
./dc.sh restart web

# Step 5: Check logs again
./dc.sh logs web -f --tail=50
```

#### **7. Before Committing Code**

```bash
# Complete checklist before committing:

# 1. Run tests
./dc.sh exec web pytest

# 2. Check web logs for errors
./dc.sh logs web --tail=100 | grep -i error

# 3. Check celery logs
./dc.sh logs celery-worker --tail=50 | grep -i error

# 4. Verify migrations applied
./dc.sh exec web python manage.py showmigrations | grep '\[ \]'

# 5. Test critical endpoints
curl http://localhost:8000/health
curl http://localhost:8000/api/accounts/auth/check

# 6. If frontend changed, check frontend logs
./dc.sh logs web | grep -i "404\|static"
```

#### **8. Log Levels & What to Look For**

```
ERROR (red)     â†’ Code crashed, must fix before commit
WARNING (yellow) â†’ Potential issues, investigate
INFO (blue)     â†’ Normal operations, can ignore
DEBUG (gray)    â†’ Detailed info, useful for debugging

Most important: Watch for ERROR and WARNING levels
```

#### **9. Useful Log Commands**

```bash
# Last N lines from web service
./dc.sh logs web --tail=100

# Follow logs in real-time (Ctrl+C to exit)
./dc.sh logs web -f

# Get logs since 10 minutes ago
./dc.sh logs web --since=10m

# Get logs for specific time range
./dc.sh logs web --since=2026-01-14T10:00:00 --until=2026-01-14T11:00:00

# Search for specific errors
./dc.sh logs web | grep "ValueError"

# Get last error
./dc.sh logs web --tail=500 | grep -A5 "ERROR"

# Combine services (see all at once)
./dc.sh logs --tail=50 web celery-worker db
```

#### **10. Database Testing**

```bash
# Connect to database
./dc.sh exec db psql -U finance -d finance

# Or from Django shell
./dc.sh exec web python manage.py shell

# > from banking.models import Transaction
# > Transaction.objects.count()  # Verify data exists
# > exit()
```

#### **11. Celery Task Testing**

```bash
# Monitor Celery worker
./dc.sh logs celery-worker -f

# Test task directly
./dc.sh exec web python manage.py shell
# > from banking.tasks import detect_recurring_transactions_task
# > detect_recurring_transactions_task.delay(account_id=1)
# > exit()

# Check Celery stats
./dc.sh exec celery-worker celery -A finance_project inspect active
```

#### **âœ… Testing Checklist Before Committing**

- [ ] Services running: `./dc.sh ps` shows all healthy
- [ ] Web logs clean: `./dc.sh logs web --tail=100 | grep ERROR`
- [ ] Tests pass: `./dc.sh exec web pytest`
- [ ] Migrations applied: `./dc.sh exec web python manage.py showmigrations`
- [ ] No celery errors: `./dc.sh logs celery-worker --tail=50 | grep ERROR`
- [ ] Health check passes: `curl http://localhost:8000/health`
- [ ] API working: `curl http://localhost:8000/api/accounts/auth/check`
- [ ] Frontend loads: `curl http://localhost:8000`
- [ ] Database connected: `./dc.sh exec db psql -U finance -d finance -c "SELECT 1"`
- [ ] No static file errors: `./dc.sh logs web --tail=100 | grep 404`

---

### **1. PROJECT_DOCUMENTATION.md is Master Reference**
- Location: `documentation/PROJECT_DOCUMENTATION.md`
- Size: 1815 lines of comprehensive documentation
- Purpose: Single source of truth for entire project
- Coverage: Technologies, architecture, database, APIs, features, design decisions

### **2. Before Starting Any Work**
- [ ] **Setup**: Ensure `./dc.sh` is working and services are running with `./dc.sh up -d`
- [ ] **Verify Services**: Run `./dc.sh ps` and verify all services show as running
- [ ] **Check Health**: Run `./dc.sh logs web --tail=50 | grep ERROR` to ensure no startup errors
- [ ] **Test API**: Verify `curl http://localhost:8000/health` returns success
- [ ] Read relevant sections of PROJECT_DOCUMENTATION.md
- [ ] Check Design Decisions section for similar patterns
- [ ] Review Database Design if data model changes needed
- [ ] Check API Architecture if adding endpoints
- [ ] Understand Security Measures
- [ ] Check Performance Optimization section

### **3. For Every New Feature**
1. **Planning Phase**
   - Read PROJECT_DOCUMENTATION.md relevant sections
   - Review similar existing features
   - Check design decisions for this type of work
   
2. **Implementation Phase**
   - Follow patterns established in PROJECT_DOCUMENTATION.md
   - Use same naming conventions
   - Apply same security measures
   - Follow same architectural patterns
   
3. **Documentation Phase**
   - Update PROJECT_DOCUMENTATION.md IMMEDIATELY
   - Add new sections if major feature
   - List new API endpoints
   - Document design decisions
   - Update Technology Stack if needed
   - Add to feature list
   
4. **Testing & Verification Phase**
   - **Test with Docker:** `./dc.sh up -d` then `./dc.sh exec web pytest`
   - **Check logs:** `./dc.sh logs web --tail=100 | grep ERROR`
   - **Verify no breaking changes:** Run full test suite
   - **Check performance:** Review logs for slow queries
   - **Verify security:** Check authentication/authorization
   - Test thoroughly with real data

### **4. For Every Bug Fix**
1. Check PROJECT_DOCUMENTATION.md for context
2. Understand root cause (document it)
3. Implement fix
4. **Test the fix:** `./dc.sh exec web pytest` to verify
5. **Check logs:** `./dc.sh logs web -f --tail=100` for errors
6. Add to "Critical Bugs Fixed" section in PROJECT_DOCUMENTATION.md
7. Update relevant documentation sections
8. Test to prevent regression
9. **Verify in logs:** No errors appear after fix

### **5. For Every Enhancement/Improvement**
1. Check PROJECT_DOCUMENTATION.md for current implementation
2. Review design decisions for similar work
3. Implement enhancement
4. **Run tests:** `./dc.sh exec web pytest`
5. **Check logs:** `./dc.sh logs web celery-worker --tail=100 | grep -i error`
6. Update PROJECT_DOCUMENTATION.md documentation
7. Verify performance/security implications
8. Test thoroughly

### **6. For Configuration/Settings Changes**
- Update "Environment Configuration" section in PROJECT_DOCUMENTATION.md
- List all environment variables
- Document defaults
- Explain purpose of each
- **Test changes:** Restart services with `./dc.sh restart`
- **Verify:** Check logs for configuration errors

### **7. For Database Changes**
- Update "Database Design" section
- Show model changes
- Update relationships
- Add field explanations
- Update indexes if needed
- **Create migrations locally:** `python manage.py makemigrations`
- **Apply with Docker:** `./dc.sh exec web python manage.py migrate`
- **Test:** `./dc.sh logs web --tail=50 | grep migration`
- **Verify:** Check that showmigrations shows all applied

### **8. For API Changes**
- Update "API Architecture" section
- List endpoint method, path, purpose
- Show affected features
- Document request/response format
- Add error handling
- **Test endpoint:** `curl http://localhost:8000/api/new/endpoint/`
- **Check logs:** `./dc.sh logs web --tail=100` for 404s or errors
- **Run tests:** `./dc.sh exec web pytest tests/test_api.py`

### **9. For Async/Long-Running Tasks**
- **Follow the Task Polling Pattern:** See "Async Task Polling Pattern" in PROJECT_DOCUMENTATION.md
- Create Celery task in `apps/{app}/tasks.py`
- Add start endpoint returning `(task_id, 202 ACCEPTED)`
- Add task status endpoint checking `AsyncResult(task_id)`
- **Frontend:** Use polling loop checking status every 1 second
- **Max timeout:** 5 minutes (300 attempts)
- **Modal behavior:** Show loading â†’ success/error â†’ auto-close
- **ESC key:** Allow users to close modal during loading
- **Test:** Verify task completion via logs: `./dc.sh logs celery-worker -f --tail=50`
- **Document:** Update "Async Task Polling Pattern" section if pattern changes
- Real-world example: AI category generation (`/api/ai/generate-categories` + `/api/ai/task-status/<task_id>`)

---

## ðŸ“‹ PROJECT_DOCUMENTATION.md Sections to Know

```
1. Executive Summary - Quick overview
2. Technology Stack - All technologies used
3. Project Structure - File/folder organization
4. Database Design - All 7 models, 50+ fields
5. API Architecture - 40+ endpoints documented
6. Authentication & Users - Google OAuth setup
7. Bank Accounts & Transactions - Core features
8. Categories & Rules - Categorization system
9. Recurring Transactions - Subscription detection
10. AI Insights - Ollama integration
11. Analytics - Statistics and trends
12. Frontend Architecture - React/components
13. UI Components & Features - All UI elements
14. Sensitive Mode - Blur financial data feature
15. Format Preferences - Date/currency/number formatting
16. Internationalization - Language support (EN+DE)
17. Docker Compose Setup - Container orchestration
18. Environment Configuration - All env variables
19. Background Tasks (Celery) - Async jobs
20. Database Migrations - Schema management
21. Design Decisions - 15+ decisions with reasoning
22. Critical Bugs Fixed - All bug fixes documented
23. Security Measures - 8 security features
24. Performance Optimization - Speed improvements
25. Future Enhancements - Roadmap
26. Development Guide - Setup and development
27. Support & Troubleshooting - Common issues
```

---

## ðŸŽ¯ Chat Starting Template

**Use this format when starting a new PyCharm chat:**

```
I'm working on [Finance Forecast project].

Following .INSTRUCTIONS.md rules:
- Using PROJECT_DOCUMENTATION.md as authoritative reference
- Will update PROJECT_DOCUMENTATION.md after implementation

Feature/Task: [What I want to build]

Context from PROJECT_DOCUMENTATION.md: [Reference relevant sections]

Requirements: [What it should do]

Success Criteria: [How to know it's done]
```

---

## âœ… Checklist Before Submitting Work

**Testing & Verification (REQUIRED):**
- [ ] Services running: `./dc.sh ps` shows all healthy
- [ ] Web logs clean: `./dc.sh logs web --tail=100 | grep ERROR` (no errors)
- [ ] Tests pass: `./dc.sh exec web pytest`
- [ ] Migrations applied: `./dc.sh exec web python manage.py showmigrations` (no pending)
- [ ] No celery errors: `./dc.sh logs celery-worker --tail=50 | grep ERROR`
- [ ] Health check passes: `curl http://localhost:8000/health`
- [ ] API working: `curl http://localhost:8000/api/accounts/auth/check`

**Code Quality:**
- [ ] Read relevant PROJECT_DOCUMENTATION.md sections
- [ ] Followed existing patterns from PROJECT_DOCUMENTATION.md
- [ ] Updated PROJECT_DOCUMENTATION.md appropriately
- [ ] Added new sections if major feature
- [ ] Updated API Architecture if endpoints changed
- [ ] Updated Database Design if models changed
- [ ] Updated Design Decisions section
- [ ] Added to feature list if new feature
- [ ] Updated Technology Stack if needed
- [ ] Tested thoroughly with Docker
- [ ] Verified no breaking changes
- [ ] Checked security implications
- [ ] Verified performance impact (check logs for slow queries)

---

## ðŸ“ž Key PROJECT_DOCUMENTATION.md Reference Points

**When adding a feature:**
â†’ Check "Design Decisions" section for pattern

**When fixing a bug:**
â†’ Check "Critical Bugs Fixed" section for similar issues

**When adding API:**
â†’ Update "API Architecture" section with all details

**When changing database:**
â†’ Update "Database Design" section with full model

**When deploying:**
â†’ Check "Docker Compose Setup" and "Environment Configuration"

**When optimizing:**
â†’ Check "Performance Optimization" section for best practices

**When securing:**
â†’ Check "Security Measures" section for requirements

---

## ðŸš€ What Not To Do

âŒ Use `docker compose -f deploy/docker-compose.yml` directly (use `./dc.sh` instead)  
âŒ Create migrations with `./dc.sh` (use local `python manage.py makemigrations`)  
âŒ **Commit code without testing:** Always run `./dc.sh exec web pytest` first  
âŒ **Ignore service errors:** Check `./dc.sh logs web --tail=100` for errors  
âŒ **Skip log review:** Always check for ERROR and WARNING in logs  
âŒ Make decisions without checking PROJECT_DOCUMENTATION.md  
âŒ Forget to update PROJECT_DOCUMENTATION.md after changes  
âŒ Document features outside of PROJECT_DOCUMENTATION.md  
âŒ Create new patterns instead of following existing ones  
âŒ Add undocumented API endpoints  
âŒ Change database without updating PROJECT_DOCUMENTATION.md  
âŒ Ignore Design Decisions when implementing similar features  
âŒ Skip security/performance checks  

---

## ðŸ’¡ Key Patterns from PROJECT_DOCUMENTATION.md

**Authentication:** Google OAuth2 via django-allauth  
**Database:** PostgreSQL with Decimal fields for money  
**API:** DRF with pagination, filtering, OpenAPI schema  
**Frontend:** React 18 with Tailwind, state in index.jsx  
**Background Tasks:** Celery with Redis  
**AI/LLM:** Ollama HTTP API with GEMMA2 model  
**Deployment:** Docker Compose with 6 services  
**Language Support:** English + German (1000+ keys)  
**Special Features:** SensitiveMode, Format Preferences, i18n  

---

## ðŸ“ When to Update PROJECT_DOCUMENTATION.md

**Immediately after:**
- âœ… Implementing new feature
- âœ… Fixing critical bug
- âœ… Adding API endpoint
- âœ… Changing database model
- âœ… Making design decision
- âœ… Adding configuration
- âœ… Implementing security measure
- âœ… Performance optimization

**Show what was changed:**
- New sections added
- Sections updated
- Design decisions documented
- Features listed

---

## ðŸ”„ Continuous Update Policy

PROJECT_DOCUMENTATION.md is **NOT** a static document. It **MUST** be updated:
- After every feature implementation
- After every bug fix
- After every design decision
- After every configuration change
- After every database change
- After every API addition
- After every refactoring

**PROJECT_DOCUMENTATION.md is a living document that reflects the current state of the project.**

---

## âœ¨ Remember

> "PROJECT_DOCUMENTATION.md is the single source of truth. Every decision flows through it. Every feature gets documented in it. Every change is recorded in it."

---

## ðŸ“‹ Quick Reference

| Need | PROJECT_DOCUMENTATION.md Section |
|------|-------------------|
| Feature idea | Design Decisions |
| Database question | Database Design |
| API endpoint | API Architecture |
| Configuration | Environment Configuration |
| Deployment | Docker Compose Setup |
| Technology choice | Technology Stack |
| Bug pattern | Critical Bugs Fixed |
| Security question | Security Measures |
| Performance issue | Performance Optimization |
| Frontend component | UI Components & Features |
| Special feature | Sensitive Mode / Format Preferences / i18n |

---

## ðŸ§ª Testing & Debugging Reminders

**Always test code before committing:**

```bash
# The golden testing sequence:

# 1. Start/verify services
./dc.sh up -d && ./dc.sh ps

# 2. Run tests
./dc.sh exec web pytest

# 3. Check for errors
./dc.sh logs web --tail=100 | grep -i error

# 4. Verify migrations
./dc.sh exec web python manage.py showmigrations

# 5. Check API health
curl http://localhost:8000/health

# 6. Test your specific feature
curl http://localhost:8000/api/your/endpoint/

# 7. Check celery (if background tasks changed)
./dc.sh logs celery-worker --tail=50 | grep -i error

# If anything shows ERROR or FAILED â†’ FIX BEFORE COMMITTING
```

**Key Testing Rules:**
- âœ… **Always test with Docker:** Code must work in `./dc.sh` environment
- âœ… **Check logs first:** `./dc.sh logs web` catches 80% of issues
- âœ… **Never ignore errors:** Even WARNING level needs investigation
- âœ… **Test edge cases:** Not just happy path
- âœ… **Verify database:** Migrations must apply cleanly
- âœ… **Check API responses:** 200 status â‰  correct data
- âœ… **Test in browser:** Frontend rendering matters
- âœ… **Review logs after testing:** Ensure no background errors

---

## ðŸŽ¯ Final Reminder

**Every chat should:**
1. Start by checking PROJECT_DOCUMENTATION.md
2. Follow patterns from PROJECT_DOCUMENTATION.md
3. **Always test code with `./dc.sh` and check logs**
4. End by updating PROJECT_DOCUMENTATION.md
5. Document everything in PROJECT_DOCUMENTATION.md

**PROJECT_DOCUMENTATION.md = Your project blueprint. Treat it like sacred truth.**

**`./dc.sh` = Your testing environment. Verify all changes here before committing.**

---

**Version 2.0 | January 14, 2026 | Added Section 0.5: Testing & Logs**

